<div class="card shadow-none">
  @if (showHeader) {
    <div class="card-header [onLazyLoad]">
      @if (!isSubComponent) {
        <button
          (click)="onLazyLoad()"
          type="submit"
          class="btn btn-primary m-1"
          [disabled]="loading"
        >
          Buscar
        </button>
      }

      @if (hasPermission2new) {
        <button
          (click)="onAddNew()"
          type="button"
          class="btn btn-warning m-1"
        >
          Crear {{ itemLabels?.ownName }}
        </button>
      }
    </div>
  }
  @if (showHeader) {
    <div class="card-header d-flex justify-content-between [clearFilters]">
      <div class="d-block">
        @if (!isSubComponent) {
          <button
            class="text-dark btn btn-link m-1"
            type="button"
            (click)="clearFilters()"
          >
            Limpiar filtros de búsqueda
          </button>
        }
        &nbsp;
      </div>

      <small class="text-dark m-1">
        {{ responseList?.totalElements | number }}
      </small>
    </div>
  }

  @if (responseList?.content) {
    <div class="card-body position-relative [responseList.content-{{ responseList?.content?.length }}]">
      <div
        class="table-full-width t-responsive table-responsive"
        [class.max-h-500]="modelSearch.tableScrolled && modelSearch.lazyLoadEvent.rows > 10"
      >
        <table
          jfStickyTable
          class="table-striped table-hover table"
          [ngClass]="{'text-nowrap': tableNoWrap, 'table-bordered': tableBordered, 'table-sm': tableSm}"
        >
          <thead
            class="text-primary z-index-900"
            [ngClass]="{'sticky-top bg-white': modelSearch.tableScrolled}"
          >
            <tr>
              @for (_field of modelSearch.fieldsSelected; track _field.field) {
                <th
                  [jfMultiSortMeta]="_field"
                  [host]="this"
                  [jfStickyTableCell]="_field.fixed"
                  scope="col"
                >
                  <div
                    class="w-100 h-100"
                    [class.border-end]="_field.fixed"
                  >
                    {{ _field.label }}
                  </div>
                </th>
              }

              @if (hasPermission2delete) {
                <th></th>
              }
            </tr>
          </thead>
          <tbody>
            @for (model of responseList?.content; track model[itemLabels.tablePK]) {
              <tr>
                @for (_field of modelSearch.fieldsSelected; track _field.field) {
                  <td [jfStickyTableCell]="_field.fixed">
                    <div
                      class="w-100 h-100"
                      [class.jf-sticky]="_field.fixed"
                    >
                      <div class="d-none d-sm-block d-md-none fw-bold">{{ _field.label }}</div>

                      @switch (_field.type) {
                        @case ('projection') {
                          <ng-container
                            *ngTemplateOutlet="templateRef; context: {pItem: model, pFieldName: _field.name}"
                          ></ng-container>
                        }
                        @case ('custom') {
                          @if (!!model.customLabels ? model.customLabels[_field.name + '_label'] : false) {
                            {{ model.customLabels[_field.name + '_label'] }}:
                            <small>( {{ model[_field.name] }} )</small>
                          }
                        }
                        @case ('pk') {
                          <button
                            (click)="onRowSelect(model, _field.field)"
                            type="button"
                            class="btn btn-info m-0 px-2 py-1 row-select-{{ _field.name }}-{{ model[_field.name] }}"
                            title="Ver {{ itemLabels?.ownName }} {{ _field.label }}: {{ model[_field.name] }}"
                            [disabled]="!hasPermission2show"
                          >
                            {{ model[_field.name] }}
                          </button>
                        }
                        @case ('date') {
                          {{ model[_field.name] | date: 'd/M/y' }}
                        }
                        @case ('date-time') {
                          {{ model[_field.name] | date: 'd/M/y, hh:mm a' }}
                        }
                        @case ('boolean') {
                          <div
                            [innerHTML]="
                              model[_field.name]
                                ? '<i class=\'fas fa-check-circle text-success\'></i>'
                                : '<i class=\'fas fa-times-circle text-danger\'></i>'
                            "
                          ></div>
                        }
                        @case ('date-time') {
                          {{ model[_field.name] }}
                        }
                        @default {
                          {{ model[_field.name] | jfTruncate: tableTruncate : ' ...' }}
                        }
                      }
                    </div>
                  </td>
                }
                @if (hasPermission2delete) {
                  <td>
                    <button
                      (click)="showDeleteDialog(model)"
                      type="button"
                      [title]="'Borrar ' + itemLabels?.ownName"
                      class="btn btn-sm btn-danger btn-round btn-icon btn-icon-mini btn-neutral"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </td>
                }
              </tr>
            } @empty {
              No resultados
            }
          </tbody>
        </table>
      </div>
    </div>
  }

  @if (showFooter) {
    <div class="card-footer [export]">
      <div class="row">
        <div class="col">
          @if (responseList?.totalElements) {
            <div class="d-block w-100 text-start">
              <button
                (click)="openScrollableContent(longContent)"
                type="button"
                class="btn btn-sm btn-round btn-icon bg-primary m-1 p-1 text-white"
              >
                <i class="fas fa-cog"></i>
              </button>

              <ngb-pagination
                [collectionSize]="responseList.totalElements"
                [page]="modelSearch.lazyLoadEvent.first"
                [pageSize]="modelSearch.lazyLoadEvent.rows"
                size="sm"
                [maxSize]="5"
                [boundaryLinks]="true"
                (pageChange)="changePage($event)"
                class="d-inline-block"
              ></ngb-pagination>

              <div class="ui-paginator ui-dropdown d-inline-block m-0 p-1">
                <select
                  id="select-qty-table"
                  name="select-qty-table"
                  class="form-control"
                  [(ngModel)]="modelSearch.lazyLoadEvent.rows"
                  (change)="changePageLimit($event)"
                  aria-placeholder="Máximo de filas"
                  placeholder="Máximo de filas"
                  ngbTooltip="Máximo de filas"
                >
                  @for (q of labels.misc.pageLimit; track q.v) {
                    <option [value]="q.v">{{ q.c }}</option>
                  }
                </select>
              </div>

              @if (responseList.totalElements > 100) {
                <div class="ui-paginator ui-dropdown d-inline-block m-0 p-1">
                  <div class="input-group">
                    <input
                      #i
                      type="number"
                      inputmode="numeric"
                      pattern="[0-9]*"
                      class="form-control"
                      ngbTooltip="Ir a Nro de página"
                      id="go-to-page-input"
                      aria-describedby="got-to-page-button"
                    />
                    <button
                      class="btn btn-outline-secondary"
                      type="button"
                      id="got-to-page-button"
                      (click)="changePage(+i.value); i.value = ''"
                    >
                      Nro de página
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </div>
        <div class="col">
          @if (allowExport) {
            <div class="d-block w-100 text-end">
              <div class="d-inline-block ui-paginator ui-dropdown m-0 p-1">
                <select
                  id="select-type-table"
                  name="select-type-table"
                  class="form-control"
                  [(ngModel)]="modelSearch.exportFileType"
                >
                  @for (item of labels.k.exportFileTypes; track item.c) {
                    <option [value]="item.c">{{ item.v }}</option>
                  }
                </select>
              </div>
              <div class="d-inline-block">
                <button
                  (click)="onLazyLoad('export')"
                  type="button"
                  class="btn btn-primary w-100 m-1"
                >
                  Exportar resultados
                </button>
              </div>
            </div>
          }
        </div>
      </div>
      <div class="row">
        <div class="col">
          @if (allowImport && hasPermission2delete && csvFileDelete?.field) {
            <base-cms-file-upload
              [additionalParameter]="csvDelete"
              [labels]="labels"
              id="model-deleter"
              cardClass="border border-danger"
              minHeight="100px"
              label="Eliminar ( CSV )"
              [name]="csvFileDelete.field"
              [showPublicPath]="false"
              [error]="csv?.error?.error"
              [url2showStaticImage]="labels.misc.csv"
              [allowedTypes]="['text/csv', 'application/vnd.ms-excel']"
              [url2send]="url2send"
              [value]="csvFileDelete"
              (fileUploader)="gFileUploader($event)"
              (finish)="massiveInsert($event)"
            />
          }
        </div>
        <div class="col">
          @if (allowImport && hasPermission2new) {
            <base-cms-file-upload
              [additionalParameter]="modelSearch.csv"
              [labels]="labels"
              id="model-importer"
              cardClass="border"
              minHeight="100px"
              label="Importar ( CSV )"
              [name]="csvFile.field"
              [showPublicPath]="false"
              [error]="csv?.error?.error"
              [url2showStaticImage]="labels.misc.csv"
              [allowedTypes]="['text/csv', 'application/vnd.ms-excel']"
              [url2send]="url2send"
              [value]="csvFile"
              (fileUploader)="gFileUploader($event)"
              (finish)="massiveInsert($event)"
            />
          }
        </div>
      </div>
      @if (loading) {
        <base-cms-spinner-loading class="m-4" />
      }
    </div>
  }
</div>

<ng-template
  #longContent
  let-modal
>
  <div class="modal-header">
    <h4 class="modal-title">Personalización lista</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <table class="table-xm table-striped table-hover table-bordered table">
      <thead class="text-primary text-nowrap">
        <tr>
          <th scope="col">
            <button
              type="button"
              class="btn btn-link"
              (click)="unselect()"
            >
              Ver ( <i class="fas fa-eye-slash"></i> )
            </button>
          </th>
          <th scope="col">Fijar</th>
          <th scope="col">Nombre</th>
          <th scope="col">Orden</th>
        </tr>
      </thead>
      <tbody
        cdkDropList
        [cdkDropListData]="modelSearch.fields"
        (cdkDropListDropped)="drop($event)"
      >
        @for (_field of modelSearch.fields; track _field.field) {
          <tr
            cdkDrag
            class="table-success text-center"
            [class.table-light]="!_field.allowInList"
          >
            <td>
              <input
                class="form-check-input mx-1"
                type="checkbox"
                [id]="_field.field + '-selected'"
                [name]="_field.field + '-selected'"
                [(ngModel)]="_field.allowInList"
              />
            </td>
            <td>
              <input
                class="form-check-input mx-1"
                type="checkbox"
                [id]="_field.field + '-fixed'"
                [name]="_field.field + '-fixed'"
                [(ngModel)]="_field.fixed"
              />
            </td>
            <th
              scope="row"
              class="cursor-move text-start"
            >
              {{ _field.label }}
            </th>
            <td>{{ 0 }}</td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-success"
      (click)="saveFields()"
    >
      Seleccionar
    </button>
    <button
      type="button"
      class="btn btn-light"
      (click)="modal.close('Close click')"
    >
      Cerrar
    </button>
  </div>
</ng-template>
