<div class="card shadow-none">
  <div class="card-header [onLazyLoad]" *ngIf="showHeader">
    <button
      (click)="onLazyLoad()"
      type="submit"
      class="btn btn-primary m-1"
      [disabled]="loading"
      *ngIf="!isSubComponent"
    >
      Buscar
    </button>
    <button (click)="onAddNew()" type="button" class="btn btn-warning m-1" *ngIf="hasPermission2new">
      Crear {{ itemLabels?.ownName }}
    </button>
  </div>
  <div class="card-header d-flex justify-content-between [clearFilters]" *ngIf="showHeader">
    <button class="text-dark m-1 btn btn-link" type="button" (click)="clearFilters()" *ngIf="!isSubComponent">
      Limpiar filtros de búsqueda
    </button>
    <small class="text-dark m-1">
      {{ responseList?.totalElements | number }}
    </small>
  </div>
  <div
    class="card-body position-relative [responseList.content-{{ responseList?.content?.length }}]"
    *ngIf="responseList?.content"
  >
    <div
      class="table-full-width t-responsive table-responsive"
      [class.max-h-500]="modelSearch.tableScrolled && modelSearch.lazyLoadEvent.rows > 10"
    >
      <table
        jfStickyTable
        class="table table-striped table-hover"
        [ngClass]="{'text-nowrap': tableNoWrap, 'table-bordered': tableBordered, 'table-sm': tableSm}"
      >
        <thead class="text-primary" [jfStickyHeader]="modelSearch.tableScrolled">
          <tr>
            <th
              *ngFor="let _field of modelSearch.fieldsSelected"
              [jfMultiSortMeta]="_field"
              [host]="this"
              [jfSticky]="_field.fixed"
              scope="col"
            >
              <div class="w-100 h-100" [class.border-end]="_field.fixed">
                {{ _field.label }}
              </div>
            </th>
            <th *ngIf="hasPermission2delete"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let model of responseList?.content">
            <td *ngFor="let _field of modelSearch.fieldsSelected" [ngSwitch]="_field.type" [jfSticky]="_field.fixed">
              <div class="w-100 h-100" [class.jf-sticky]="_field.fixed">
                <div class="d-none d-sm-block d-md-none fw-bold">{{ _field.label }}</div>

                <!-- ***** ***** ***** [pre-code] ***** ***** ***** -->
                <ng-container *ngSwitchCase="'projection'">
                  <ng-container
                    *ngTemplateOutlet="templateRef; context: {pItem: model, pFieldName: _field.name}"
                  ></ng-container>
                </ng-container>
                <!-- ***** ***** ***** [pre-code] ***** ***** ***** -->

                <!-- ***** ***** ***** [custom] ***** ***** ***** -->
                <ng-container *ngSwitchCase="'custom'">
                  <ng-container *ngIf="!!model.customLabels ? model.customLabels[_field.name + '_label'] : false">
                    {{ model.customLabels[_field.name + '_label'] }}: <small>( {{ model[_field.name] }} )</small>
                  </ng-container>
                </ng-container>
                <!-- ***** ***** ***** [custom] ***** ***** ***** -->

                <!-- ***** ***** ***** [pk] ***** ***** ***** -->
                <ng-container *ngSwitchCase="'pk'">
                  <button
                    (click)="onRowSelect(model, _field.field)"
                    type="button"
                    class="btn btn-info m-0 px-2 py-1 row-select-{{ _field.name }}-{{ model[_field.name] }}"
                    title="Ver {{ itemLabels?.ownName }} {{ _field.label }}: {{ model[_field.name] }}"
                    [disabled]="!hasPermission2show"
                  >
                    {{ model[_field.name] }}
                  </button>
                </ng-container>
                <!-- ***** ***** ***** [pk] ***** ***** ***** -->

                <!-- ***** ***** ***** [date] ***** ***** ***** -->
                <ng-container *ngSwitchCase="'date'">
                  {{ model[_field.name] | date : 'd/M/y' }}
                </ng-container>
                <!-- ***** ***** ***** [date] ***** ***** ***** -->

                <!-- ***** ***** ***** [date-time] ***** ***** ***** -->
                <ng-container *ngSwitchCase="'date-time'">
                  {{ model[_field.name] | date : 'd/M/y, hh:mm a' }}
                </ng-container>
                <!-- ***** ***** ***** [date-time] ***** ***** ***** -->

                <!-- ***** ***** ***** [boolean] ***** ***** ***** -->
                <ng-container *ngSwitchCase="'boolean'">
                  {{ model[_field.name] ? 'Si' : 'No' }}
                </ng-container>
                <!-- ***** ***** ***** [boolean] ***** ***** ***** -->

                <!-- ***** ***** ***** [number] ***** ***** ***** -->
                <ng-container *ngSwitchCase="'number'">
                  {{ model[_field.name] }}
                </ng-container>
                <!-- ***** ***** ***** [number] ***** ***** ***** -->

                <!-- ***** ***** ***** [default] ***** ***** ***** -->
                <ng-container *ngSwitchDefault>
                  {{ model[_field.name] | jfTruncate : tableTruncate : ' ...' }}
                </ng-container>
              </div>
            </td>

            <td *ngIf="hasPermission2delete">
              <button
                (click)="showDeleteDialog(model)"
                type="button"
                [title]="'Borrar ' + itemLabels?.ownName"
                class="btn btn-sm btn-danger btn-round btn-icon btn-icon-mini btn-neutral"
              >
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer [export]" *ngIf="showFooter">
    <div class="row">
      <div *ngIf="responseList?.totalElements" class="col-12 col-md-6">
        <button
          (click)="openScrollableContent(longContent)"
          type="button"
          class="btn btn-sm btn-round btn-icon text-white bg-primary p-1 m-1"
        >
          <i class="fas fa-cog"></i>
        </button>

        <ngb-pagination
          [collectionSize]="responseList.totalElements"
          [page]="modelSearch.lazyLoadEvent.first"
          [pageSize]="modelSearch.lazyLoadEvent.rows"
          size="sm"
          [maxSize]="5"
          [boundaryLinks]="true"
          (pageChange)="changePage($event)"
          class="d-inline-block"
        ></ngb-pagination>

        <div class="ui-paginator ui-dropdown d-inline-block p-1 m-0">
          <select
            id="select-qty-table"
            name="select-qty-table"
            class="form-control"
            [(ngModel)]="modelSearch.lazyLoadEvent.rows"
            (change)="changePageLimit($event)"
            aria-placeholder="Máximo de filas"
            placeholder="Máximo de filas"
            ngbTooltip="Máximo de filas"
          >
            <option *ngFor="let q of labels.misc.pageLimit" [value]="q.v">{{ q.c }}</option>
          </select>
        </div>

        <div class="ui-paginator ui-dropdown d-inline-block p-1 m-0" *ngIf="responseList.totalElements > 100">
          <div class="input-group">
            <input
              #i
              type="number"
              inputmode="numeric"
              pattern="[0-9]*"
              class="form-control"
              ngbTooltip="Ir a Nro de página"
              id="go-to-page-input"
              aria-describedby="got-to-page-button"
            />
            <button
              class="btn btn-outline-secondary"
              type="button"
              id="got-to-page-button"
              (click)="changePage(+i.value); i.value = ''"
            >
              Nro de página
            </button>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div *ngIf="allowExport" class="d-block w-100">
          <div class="d-inline-block ui-paginator ui-dropdown p-1 m-0">
            <select
              id="select-type-table"
              name="select-type-table"
              class="form-control"
              [(ngModel)]="modelSearch.exportFileType"
            >
              <option *ngFor="let item of labels.k.exportFileTypes" [value]="item.c">{{ item.v }}</option>
            </select>
          </div>
          <div class="d-inline-block">
            <button (click)="onLazyLoad('export')" type="button" class="btn btn-primary m-1 w-100">
              Exportar resultados
            </button>
          </div>
        </div>

        <base-cms-file-upload
          *ngIf="allowImport && hasPermission2new"
          [additionalParameter]="modelSearch.csv"
          [labels]="labels"
          id="model-importer"
          class="h-100"
          minHeight="100px"
          label="Importar CSV"
          name="massive-inserts"
          [showPublicPath]="false"
          [error]="csv?.error?.error"
          (fileUploader)="gFileUploader($event)"
          (finish)="massiveInsert($event)"
          [url2showStaticImage]="labels.misc.csv"
          [allowedTypes]="['text/csv', 'application/vnd.ms-excel']"
          [url2send]="url2send"
          [value]="{id: -1, entity: itemLabels?.tableName, field: 'massive-inserts'}"
        ></base-cms-file-upload>
      </div>
    </div>
    <base-cms-spinner-loading *ngIf="loading" class="m-4"></base-cms-spinner-loading>
  </div>
</div>

<ng-template #longContent let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Personalización lista</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
    <table class="table table-xm table-striped table-hover table-bordered">
      <thead class="text-primary text-nowrap">
        <tr>
          <th scope="col">
            <div (click)="unselect()">Ver ( <i class="fas fa-eye-slash"></i> )</div>
          </th>
          <th scope="col">Fijar</th>
          <th scope="col">Nombre</th>
          <th scope="col">Orden</th>
        </tr>
      </thead>
      <tbody cdkDropList [cdkDropListData]="modelSearch.fields" (cdkDropListDropped)="drop($event)">
        <tr
          *ngFor="let _field of modelSearch.fields; let i = index"
          cdkDrag
          class="table-success text-center"
          [class.table-light]="!_field.allowInList"
        >
          <td>
            <input
              class="form-check-input mx-1"
              type="checkbox"
              [name]="_field.field + '-selected'"
              [(ngModel)]="_field.allowInList"
            />
          </td>
          <td>
            <input
              class="form-check-input mx-1"
              type="checkbox"
              [name]="_field.field + '-fixed'"
              [(ngModel)]="_field.fixed"
            />
          </td>
          <th scope="row" class="text-start cursor-move">
            {{ _field.label }}
          </th>
          <td>{{ i + 1 }}</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-success" (click)="saveFields()">Seleccionar</button>
    <button type="button" class="btn btn-light" (click)="modal.close('Close click')">Cerrar</button>
  </div>
</ng-template>
